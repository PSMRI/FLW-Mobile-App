name: Build and Distribute

on:
  workflow_call:
    inputs:
      branch:
        required: true
        type: string
      environment:
        required: true
        type: string
      flavor:
        required: true
        type: string
      build_type:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Cache NDK
        uses: actions/cache@v4
        with:
          path: /usr/local/lib/android/sdk/ndk
          key: ubuntu-latest-ndk-r29

      - name: Cache CMake
        uses: actions/cache@v4
        with:
          path: ~/.cmake
          key: ubuntu-latest-cmake-3.31.1

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v2

      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1.5.0
        with:
          ndk-version: r29
          link-to-sdk: true

      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.31.1'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1.4
          bundler-cache: true

      - name: Verify Ruby
        run: ruby -v

      - name: Decode google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_GENERIC }}" | base64 --decode > app/google-services.json

      - name: Decode Firebase credentials
        if: inputs.build_type == 'debug'
        run: |
          echo "${{ secrets.FIREBASE_CREDENTIALS_JSON }}" | base64 --decode > firebase_credentials.json

      - name: Decode Google Play JSON key
        if: inputs.build_type == 'release'
        run: |
          echo "${{ secrets.GOOGLE_PLAY_JSON_KEY }}" | base64 --decode > fastlane/google_play_service_account.json

      - name: Decode keystore
        if: inputs.build_type == 'release'
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > keystore.jks

      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      - name: Build and Distribute
        env:
          # Inputs as env vars to avoid shell injection (inputs.version is free-text)
          INPUT_FLAVOR: ${{ inputs.flavor }}
          INPUT_VERSION: ${{ inputs.version }}
          INPUT_BUILD_TYPE: ${{ inputs.build_type }}
          # Native build env vars (must match CMakeLists.txt)
          ENCRYPTED_PASS_KEY: ${{ secrets.ENCRYPTED_PASS_KEY }}
          ABHA_CLIENT_SECRET: ${{ secrets.ABHA_CLIENT_SECRET }}
          ABHA_CLIENT_ID: ${{ secrets.ABHA_CLIENT_ID }}
          BASE_TMC_URL: ${{ vars.BASE_TMC_URL }}
          BASE_ABHA_URL: ${{ vars.BASE_ABHA_URL }}
          ABHA_TOKEN_URL: ${{ vars.ABHA_TOKEN_URL }}
          ABHA_AUTH_URL: ${{ vars.ABHA_AUTH_URL }}
          CHAT_URL: ${{ vars.CHAT_URL }}
          # Signing env vars (used by Fastlane for release builds)
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          # Firebase env vars
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        run: |
          if [ "$INPUT_BUILD_TYPE" = "debug" ]; then
            bundle exec fastlane build_and_distribute_debug flavor:"$INPUT_FLAVOR" version_name:"$INPUT_VERSION"
          else
            bundle exec fastlane build_and_distribute_release flavor:"$INPUT_FLAVOR" version_name:"$INPUT_VERSION"
          fi
